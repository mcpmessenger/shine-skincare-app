commands:
  01_install_system_deps:
    command: "yum install -y gcc gcc-c++ python3-devel lapack-devel blas-devel atlas-devel libffi-devel openssl-devel"
    ignoreErrors: false
    
  02_create_tmp_space:
    command: "mkdir -p /tmp/pip-build && chmod 777 /tmp/pip-build"
    ignoreErrors: true
    
  03_upgrade_pip:
    command: "/var/app/venv/staging-LQM1lest/bin/pip install --upgrade pip==23.3.1 setuptools==69.0.2 wheel==0.42.0"
    ignoreErrors: false
    
  04_set_pip_config:
    command: |
      mkdir -p /var/app/venv/staging-LQM1lest/pip
      echo "[global]" > /var/app/venv/staging-LQM1lest/pip/pip.conf
      echo "cache-dir = /tmp/pip-cache" >> /var/app/venv/staging-LQM1lest/pip/pip.conf
      echo "build = /tmp/pip-build" >> /var/app/venv/staging-LQM1lest/pip/pip.conf
      echo "timeout = 300" >> /var/app/venv/staging-LQM1lest/pip/pip.conf
      echo "retries = 3" >> /var/app/venv/staging-LQM1lest/pip/pip.conf
    ignoreErrors: true
    
  05_install_numpy_first:
    command: "/var/app/venv/staging-LQM1lest/bin/pip install numpy==1.24.3 --no-cache-dir --compile --no-build-isolation"
    ignoreErrors: false
    
  06_install_core_ml_deps:
    command: |
      /var/app/venv/staging-LQM1lest/bin/pip install --no-cache-dir --compile \
        scipy==1.11.4 \
        scikit-learn==1.3.2 \
        --no-build-isolation
    ignoreErrors: true
    
  07_install_faiss:
    command: "/var/app/venv/staging-LQM1lest/bin/pip install faiss-cpu==1.7.4 --no-cache-dir --no-build-isolation"
    ignoreErrors: true
    
  08_install_opencv:
    command: "/var/app/venv/staging-LQM1lest/bin/pip install opencv-python-headless==4.8.1.78 --no-cache-dir"
    ignoreErrors: true
    
  09_install_pillow:
    command: "/var/app/venv/staging-LQM1lest/bin/pip install Pillow==10.0.1 --no-cache-dir"
    ignoreErrors: true
    
  10_install_google_cloud:
    command: |
      /var/app/venv/staging-LQM1lest/bin/pip install --no-cache-dir \
        google-cloud-vision==3.4.4 \
        google-auth==2.23.4 \
        google-api-core==2.12.0
    ignoreErrors: true
    
  11_install_database_deps:
    command: |
      /var/app/venv/staging-LQM1lest/bin/pip install --no-cache-dir \
        psycopg2-binary==2.9.7 \
        supabase==1.0.4
    ignoreErrors: true
    
  12_cleanup_build_cache:
    command: "rm -rf /tmp/pip-build /tmp/pip-cache"
    ignoreErrors: true

container_commands:
  01_create_faiss_dir:
    command: "mkdir -p /var/app/current/faiss_data && chmod 755 /var/app/current/faiss_data"
  02_create_logs_dir:
    command: "mkdir -p /var/app/current/logs && chmod 755 /var/app/current/logs"
  03_set_permissions:
    command: "chown -R webapp:webapp /var/app/current/faiss_data /var/app/current/logs"