commands:
  01_create_swap_file:
    command: |
      # Create 8GB swap file for ML workloads
      if [ ! -f /var/swap.1 ]; then
        /bin/dd if=/dev/zero of=/var/swap.1 bs=1M count=8192
        /sbin/mkswap /var/swap.1
        chmod 600 /var/swap.1
      fi
    ignoreErrors: true
    
  02_enable_swap:
    command: |
      # Enable swap if not already enabled
      if ! swapon -s | grep -q "/var/swap.1"; then
        /sbin/swapon /var/swap.1
      fi
    ignoreErrors: true
    
  03_add_swap_to_fstab:
    command: |
      # Add swap to fstab for persistence
      if ! grep -q "/var/swap.1" /etc/fstab; then
        echo "/var/swap.1 swap swap defaults 0 0" >> /etc/fstab
      fi
    ignoreErrors: true
    
  04_optimize_swappiness:
    command: |
      # Set swappiness to 10 for ML workloads (prefer RAM over swap)
      echo "vm.swappiness=10" >> /etc/sysctl.conf
      sysctl -p
    ignoreErrors: true
    
  05_set_memory_overcommit:
    command: |
      # Allow memory overcommit for large ML allocations
      echo "vm.overcommit_memory=1" >> /etc/sysctl.conf
      echo "vm.overcommit_ratio=100" >> /etc/sysctl.conf
      sysctl -p
    ignoreErrors: true

files:
  "/opt/elasticbeanstalk/hooks/appdeploy/post/99_check_swap.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      # Ensure swap is active after deployment
      if ! swapon -s | grep -q "/var/swap.1"; then
        /sbin/swapon /var/swap.1
      fi
      
      # Log memory status
      echo "Memory status after deployment:" >> /var/log/eb-activity.log
      free -h >> /var/log/eb-activity.log
      echo "Swap status:" >> /var/log/eb-activity.log
      swapon -s >> /var/log/eb-activity.log