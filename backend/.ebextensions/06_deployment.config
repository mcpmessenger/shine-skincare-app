option_settings:
  aws:elasticbeanstalk:command:
    DeploymentPolicy: RollingWithAdditionalBatch
    BatchSizeType: Percentage
    BatchSize: 30
    Timeout: 600
  aws:elasticbeanstalk:healthreporting:system:
    SystemType: enhanced
    HealthCheckSuccessThreshold: Ok
    HealthCheckURL: /api/health
  aws:elasticbeanstalk:application:
    Application Healthcheck URL: /api/health
  aws:elb:healthcheck:
    HealthyThreshold: 3
    Interval: 30
    Timeout: 5
    UnhealthyThreshold: 5
  aws:elb:loadbalancer:
    CrossZone: true
  aws:elasticbeanstalk:environment:
    LoadBalancerType: application
    ServiceRole: aws-elasticbeanstalk-service-role

files:
  "/opt/elasticbeanstalk/hooks/appdeploy/post/01_restart_services.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      # Restart services after deployment
      echo "Restarting application services..."
      
      # Clear Python cache
      find /var/app/current -name "*.pyc" -delete
      find /var/app/current -name "__pycache__" -type d -exec rm -rf {} +
      
      # Restart web server
      sudo service httpd restart
      
      # Wait for health check
      sleep 10
      
      echo "Services restarted successfully"

  "/opt/elasticbeanstalk/hooks/appdeploy/pre/01_setup_directories.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      # Setup required directories before deployment
      echo "Setting up application directories..."
      
      # Create required directories
      mkdir -p /var/app/current/faiss_data
      mkdir -p /var/app/current/logs
      mkdir -p /var/app/current/vector_cache
      
      # Set permissions
      chown -R webapp:webapp /var/app/current/faiss_data
      chown -R webapp:webapp /var/app/current/logs
      chown -R webapp:webapp /var/app/current/vector_cache
      
      chmod -R 755 /var/app/current/faiss_data
      chmod -R 755 /var/app/current/logs
      chmod -R 755 /var/app/current/vector_cache
      
      echo "Directories setup completed"